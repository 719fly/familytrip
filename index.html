<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æé¾å®¶æ— 2026 å±±æ¢¨ä¹‹æ—… V26-Stable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/dist/css/all.min.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getStorage, ref as sRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAxETK85FUVrBMKCAIKbN6N2wg1oh0gUAo",
            authDomain: "familytrip2026-d4dca.firebaseapp.com",
            projectId: "familytrip2026-d4dca",
            storageBucket: "familytrip2026-d4dca.firebasestorage.app",
            messagingSenderId: "1083192073417",
            appId: "1:1083192073417:web:93cc5fb53392323fed4118"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // è³‡æ–™å®šç¾©
        const HOME_COORD = "35.824889,138.367139";
        const travelData = [
            { date: "2/17", weekday: "TUE", stay: "å§‘å§‘å®¶", stayAddr: HOME_COORD, firstDrive: "2h 47m", firstDist: "225km", events: [{ type: "transport", title: "æ¡ƒåœ’ â” æˆç”° (TR898)", info: "06:40-10:40", map: "Narita Airport" },{ type: "food", title: "å‘³äºæ‹‰éºµ", map: "35.8304,138.3662" }], lastDrive: "2m", lastDist: "0.8km" },
            { date: "2/18", weekday: "WED", stay: "å§‘å§‘å®¶", stayAddr: HOME_COORD, firstDrive: "34m", firstDist: "31.7km", events: [{ type: "sightseeing", title: "èˆé¶´åŸå…¬åœ’", map: "èˆé¶´åŸå…¬åœ’", drive: "10m", dist: "5km" },{ type: "food", title: "äº”å‘³é¤…è“å­åº—", map: "äº”å‘³é¤…è“å­åº—", drive: "10m", dist: "3km" },{ type: "food", title: "é›ãã° akari", map: "é¶ãã°Akari" }], lastDrive: "15m", lastDist: "12km" },
            { date: "2/19", weekday: "THU", stay: "å§‘å§‘å®¶", stayAddr: HOME_COORD, firstDrive: "21m", firstDist: "16.2km", events: [{ type: "sightseeing", title: "èŒæœ¨ä¹‹æ‘", map: "èŒæœ¨ä¹‹æ‘", drive: "5m", dist: "3km" },{ type: "food", title: "ROCK é¤å»³", map: "Moeginomura ROCK", drive: "5m", dist: "1km" },{ type: "food", title: "æ¸…é‡Œã‚¸ãƒ£ãƒ  å’–å•¡å»³", map: "æ¸…é‡Œã‚¸ãƒ£ãƒ ", drive: "25m", dist: "18km" },{ type: "food", title: "ä¸¸æ”¿ãã° è•éº¥éºµ", map: "ä¸¸æ”¿ãã° é•·å‚åº—" }], lastDrive: "8m", lastDist: "4km" },
            { date: "2/20", weekday: "FRI", stay: "å§‘å§‘å®¶", stayAddr: HOME_COORD, firstDrive: "1h 24m", firstDist: "95km", events: [{ type: "food", title: "é‡‘ã¨ã (éœå²¡)", map: "é‡‘ã¨ã è‹¥æ¾ç”ºæœ¬åº—", drive: "25m", dist: "15km" },{ type: "sightseeing", title: "arinko farm æ¡è‰è“", map: "Arinko Farm", drive: "35m", dist: "25km" },{ type: "sightseeing", title: "ä¸‰ä¿æ¾åŸ", map: "ä¸‰ä¿æ¾åŸ", drive: "30m", dist: "20km" },{ type: "sightseeing", title: "å³æœç”ºååº—è¡—", map: "éœå²¡å³æœç”º", drive: "5m", dist: "2km" },{ type: "food", title: "nanaya å†°æ·‡æ·‹", map: "ãªãªã‚„ éœå²¡åº—", drive: "15m", dist: "10km" },{ type: "food", title: "tsukanto ç‚¸è±¬æ’", map: "tsukanto éœå²¡" }], lastDrive: "1h 45m", lastDist: "110km" },
            { date: "2/21", weekday: "SAT", stay: "æ—…é¤¨ã‚ã‚‰ã³é‡", stayAddr: "36.6713,138.4069", firstDrive: "55m", firstDist: "73.5km", events: [{ type: "food", title: "ç°—ä¹‹é°»è§€å…‰èŠ æ¾æœ¬åº—", map: "ç°—ä¹‹é°»è§€å…‰èŠ", drive: "30m", dist: "22km" },{ type: "sightseeing", title: "å¤§ç‹å±±è‘µè¾²å ´", map: "å¤§ç‹ã‚ã•ã³è¾²å ´", drive: "20m", dist: "15km" },{ type: "food", title: "åŒ—ã‚¢ãƒ«ãƒ—ã‚¹ç‰§å ´ç›´å£²åº—", map: "åŒ—ã‚¢ãƒ«ãƒ—ã‚¹ç‰§å ´" }], lastDrive: "1h 10m", lastDist: "65km" },
            { date: "2/22", weekday: "SUN", stay: "å§‘å§‘å®¶", stayAddr: HOME_COORD, firstDrive: "1h 38m", firstDist: "130km", events: [{ type: "sightseeing", title: "åœ°ç„è°·é‡çŒ´æº«æ³‰", map: "åœ°ç„è°·é‡çŒ¿å…¬è‹‘", drive: "1h 50m", dist: "135km" },{ type: "sightseeing", title: "è«è¨ªæ¹–", map: "è«è¨ªæ¹–", drive: "55m", dist: "50km" },{ type: "sightseeing", title: "å¥½å¸‚å¤š å—é˜¿çˆ¾å‘æ–¯åº—", map: "Costco Minami Alpus" }], lastDrive: "40m", lastDist: "30km" },
            { date: "2/23", weekday: "MON", stay: "å§‘å§‘å®¶", stayAddr: HOME_COORD, firstDrive: "30m", firstDist: "22km", events: [{ type: "food", title: "è˜‡å·æ‹‰éºµ", map: "ãƒ©ãƒ¼ãƒ¡ãƒ³è˜‡æ´² é ˆç‰ç”º", drive: "20m", dist: "14km" },{ type: "sightseeing", title: "Taiho Futaba", map: "Taiho Futaba", drive: "15m", dist: "10km" },{ type: "sightseeing", title: "ç¬›å¹å·æ°´æœå…¬åœ’", map: "ç¬›å¹å·ãƒ•ãƒ«ãƒ¼ãƒ„å…¬åœ’", drive: "5m", dist: "2km" },{ type: "sightseeing", title: "Fruit Spa PukuPuku æ³¡æ¹¯", map: "ã·ãã·ãæº«æ³‰" }], lastDrive: "50m", lastDist: "45km" },
            { date: "2/24", weekday: "TUE", stay: "å§‘å§‘å®¶", stayAddr: HOME_COORD, firstDrive: "1h 31m", firstDist: "117km", events: [{ type: "food", title: "Junchan Sushi", map: "ã˜ã‚…ã‚“ã¡ã‚ƒã‚“å¯¿å¸", drive: "15m", dist: "10km" },{ type: "food", title: "TOKYO FARM VILLAGE", map: "TOKYO FARM VILLAGE", drive: "10m", dist: "6km" },{ type: "food", title: "ãƒ‘ãƒšãƒ«ãƒ–ãƒ«ã‚° (å’–å•¡å»³)", map: "PAPPELBURG", drive: "20m", dist: "15km" },{ type: "food", title: "ã²é‚£é³¥å±± (æµæ°´å¸­ 16:00)", map: "ã²é‚£é³¥å±±" }], lastDrive: "1h 10m", lastDist: "75km" },
            { date: "2/25", weekday: "WED", stay: "å›ç¨‹", stayAddr: "Narita Airport", events: [{ type: "transport", title: "æ³°åœ‹ç…å­èˆªç©º SL395", info: "17:15-20:20", map: "Narita Airport" }] }
        ];

        let currentDayIdx = 0;
        let cloudData = {};

        // ç›£è½ Realtime Database
        onValue(ref(db, 'trips'), (snapshot) => {
            cloudData = snapshot.val() || {};
            switchDay(currentDayIdx);
        });

        window.switchDay = (i) => {
            currentDayIdx = i;
            renderNav();
            const list = document.getElementById('events-list');
            list.innerHTML = '';
            const day = travelData[i];

            if(day.firstDrive) {
                list.innerHTML += `<div class="drive-info"><hr><i class="fa-solid fa-car"></i> ğŸš— ${i === 0 ? "æˆç”°æ©Ÿå ´" : "å‰æ—¥ä¸‹æ¦»"} â” ç¬¬ä¸€ç«™ç´„ ${day.firstDrive} (${day.firstDist})<hr></div>`;
            }

            day.events.forEach((ev, evIdx) => {
                renderCard(list, ev, i, evIdx);
                if(ev.drive) list.innerHTML += `<div class="drive-info"><hr><i class="fa-solid fa-car"></i> ğŸš— é§•è»Šç´„ ${ev.drive} (${ev.dist})<hr></div>`;
            });

            if(i !== 8) {
                list.innerHTML += `<div class="drive-info"><hr><i class="fa-solid fa-house"></i> ğŸ  è¿”å›ä¸‹æ¦»è™•ç´„ ${day.lastDrive} (${day.lastDist})<hr></div>`;
                renderCard(list, { type: "stay", title: `ä»Šæ—¥ä¸‹æ¦»ï¼š${day.stay}`, map: day.stayAddr }, i, 99);
            }
        };

        function renderNav() {
            const nav = document.getElementById('date-nav');
            nav.innerHTML = '';
            travelData.forEach((day, i) => {
                const div = document.createElement('div');
                div.className = `date-item cursor-pointer ${i === currentDayIdx ? 'active' : ''}`;
                div.onclick = () => window.switchDay(i);
                div.innerHTML = `<div class="text-[10px] font-bold uppercase">${day.weekday}</div><div class="text-xl serif mt-1">${day.date.split('/')[1]}</div><div class="active-dot"></div>`;
                nav.appendChild(div);
            });
        }

        function renderCard(container, ev, dIdx, eIdx) {
            const id = `${dIdx}_${eIdx}`;
            const data = cloudData[id] || { photos: [], note: "" };
            const div = document.createElement('div');
            div.className = `card-type p-6 type-${ev.type || 'sightseeing'} shadow-sm bg-white rounded-[2rem] border-l-[6px] mb-6`;
            
            let imgsHtml = '';
            if(data.photos && data.photos.length > 0) {
                imgsHtml = `<div class="flex gap-2 mt-4 overflow-x-auto pb-2">`;
                data.photos.forEach((url, idx) => {
                    imgsHtml += `<div class="relative w-20 h-20 flex-shrink-0">
                        <img src="${url}" class="w-full h-full object-cover rounded-xl border-2 border-white shadow-sm">
                        <div class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center border-2 border-white cursor-pointer" onclick="event.stopPropagation(); window.deletePhoto('${id}', ${idx})">Ã—</div>
                    </div>`;
                });
                imgsHtml += `</div>`;
            }

            div.innerHTML = `
                <div onclick="window.openModal('${id}', '${ev.title}')">
                    <p class="text-[9px] font-black uppercase opacity-30 tracking-widest">${ev.type || 'sightseeing'}</p>
                    <h4 class="serif text-xl font-bold">${ev.title}</h4>
                    ${ev.info ? `<p class="text-xs text-red-600 font-bold mt-1">${ev.info}</p>` : ''}
                    ${imgsHtml}
                </div>
                <div class="flex gap-2 mt-6">
                    <button onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(ev.map)}')" class="btn-gray flex-1 bg-gray-100 py-4 rounded-2xl text-[13px] font-bold"><i class="fa-solid fa-location-arrow"></i> å°èˆª</button>
                    <label class="btn-gray flex-1 bg-gray-100 py-4 rounded-2xl text-[13px] font-bold text-center cursor-pointer"><i class="fa-solid fa-camera"></i> ä¸Šå‚³ç…§ç‰‡<input type="file" accept="image/*" class="hidden" onchange="window.uploadPhoto(this, '${id}')"></label>
                </div>
            `;
            container.appendChild(div);
        }

        window.openModal = (id, title) => {
            const data = cloudData[id] || { photos: [], note: "" };
            document.getElementById('modal-body').innerHTML = `
                <h2 class="serif text-3xl font-black mb-6">${title}</h2>
                <div class="bg-white p-6 rounded-3xl mb-8 border border-gray-100 shadow-inner">
                    <textarea id="note-input" onblur="window.saveNote('${id}', this.value)" placeholder="å…¨å®¶äººçš„æ—…éŠç­†è¨˜..." class="w-full h-40 bg-transparent outline-none text-sm resize-none leading-relaxed">${data.note || ''}</textarea>
                </div>
                <div class="grid grid-cols-1 gap-6">
                    ${(data.photos || []).map(url => `<img src="${url}" class="w-full rounded-3xl shadow-lg">`).join('')}
                </div>
            `;
            document.getElementById('modal').style.display = 'block';
        };

        window.saveNote = (id, val) => {
            const data = cloudData[id] || { photos: [], note: "" };
            set(ref(db, 'trips/' + id), { ...data, note: val });
        };

        window.uploadPhoto = async (input, id) => {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = async (e) => {
                const storageRef = sRef(storage, `photos/${id}_${Date.now()}.jpg`);
                await uploadString(storageRef, e.target.result, 'data_url');
                const url = await getDownloadURL(storageRef);
                const data = cloudData[id] || { photos: [], note: "" };
                const updatedPhotos = data.photos ? [...data.photos, url] : [url];
                set(ref(db, 'trips/' + id), { ...data, photos: updatedPhotos });
            };
        };

        window.deletePhoto = (id, idx) => {
            if(!confirm("åˆªé™¤ç…§ç‰‡ï¼Ÿ")) return;
            const data = cloudData[id];
            data.photos.splice(idx, 1);
            set(ref(db, 'trips/' + id), data);
        };

        window.openDailyRoute = () => {
            const day = travelData[currentDayIdx];
            const origin = currentDayIdx === 0 ? "Narita Airport" : currentIdx === 4 ? "36.6713,138.4069" : HOME_COORD;
            window.open(`https://www.google.com/maps/dir/${encodeURIComponent(origin)}/${day.events.map(e=>encodeURIComponent(e.map)).join('/')}/${encodeURIComponent(day.stayAddr)}`, '_blank');
        };

        window.closeModal = () => document.getElementById('modal').style.display = 'none';
        init();
    </script>

    <style>
        :root { --bg: #f9f7f2; --ink: #1a1a1a; --food-border: #a52a2a; --sightseeing-border: #6b705c; --transport-border: #4a5568; --stay-border: #d4a373; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); color: var(--ink); }
        .serif { font-family: 'Noto Serif TC', serif; }
        .date-nav::-webkit-scrollbar { display: none; }
        .date-item.active { transform: scale(1.1); font-weight: 900; color: var(--ink); }
        .date-item.active .active-dot { background: var(--food-border); width: 4px; height: 4px; border-radius: 50%; margin: 4px auto 0; }
        .map-overlay { background: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?auto=format&fit=crop&w=800&q=80'); background-size: cover; }
        .drive-info { display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 11px; color: #999; margin: 15px 0; }
        .drive-info hr { flex-grow: 1; border: 0; border-top: 1px dashed #ccc; }
        #modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; backdrop-filter: blur(8px); }
        .modal-content { background: var(--bg); height: 90vh; margin-top: 10vh; border-radius: 32px 32px 0 0; padding: 24px; overflow-y: auto; }
    </style>
</head>
<body class="pb-24">
    <header class="bg-white/95 sticky top-0 z-50 pt-12 pb-6 border-b border-gray-100 text-center">
        <div class="inline-block bg-gray-100 text-gray-500 px-3 py-1 rounded-full text-[10px] font-bold mb-2">2026.02 Cloud-Stable</div>
        <h1 class="serif text-3xl mb-8">æé¾å®¶æ—å±±æ¢¨ä¹‹æ—…</h1>
        <div id="date-nav" class="date-nav flex overflow-x-auto px-6 gap-4"></div>
    </header>
    <main class="px-6 mt-6">
        <div onclick="window.openDailyRoute()" class="w-full h-48 rounded-[2.5rem] map-overlay shadow-lg mb-8 flex flex-col items-center justify-center text-white cursor-pointer border-4 border-white">
            <i class="fa-solid fa-route text-4xl mb-2"></i>
            <span class="font-bold text-sm bg-black/40 px-5 py-1.5 rounded-full text-center">æŸ¥çœ‹ä»Šæ—¥å®Œæ•´è·¯å¾‘</span>
        </div>
        <div id="events-list"></div>
    </main>
    <div id="modal" onclick="window.closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-8"></div>
            <div id="modal-body"></div>
        </div>
    </div>
</body>
</html>